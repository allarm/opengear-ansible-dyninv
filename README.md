# Opengear Ansible automation

## Configuration 

1. Change the`ansible_ssh_user` to yours in `inventory/group_vars/all`.
2. Use `-k` (or `--ask-pass`) keyword with `ansible-playbook`. I do not store passwords anywhere in playbooks.
3. Make sure that variable `ftp_ip` contains the IP address of the laptop's interface, reachable from the Opengear host. You can change it in `group_var/all`.


## Inventory

I am using a directory-based inventory - static hosts file with a dynamic inventory script. To fetch the `csv` file for dynamic inventory script, you will need to run the `get_version.yml` play first.

## Basic run 

This will show the OpenGear software versions:

```bash
ansible-playbook -i inventory/ playbooks/show_version.yml --extra-vars "ansible_ssh_user=username" -k
```

### Static groups

`File`: inventory/hosts

- lab (xxx1 nts)
- All site codes (xxx1, bbb4, etc)
- Regional groups (pppc, us, emea)
- group_a (aaa2, bbb4)
- group_b (the rest)

### Dynamic groups

`Script`: inventory/dynamic_inventory.py

Here's how to run up the playbook with dynamic inventory:

#+BEGIN_SRC sh
ansible-playbook -i dynamic_inventory.py playbook.yml
#+END_SRC

It looks for the `dyninv_input.csv` file, that should be generated by the `get_version.yml` play. It generates a `json` inventory output with the following lists:

- "model"
- "sitecode"
- "sitecode_model"

It allows to apply the chages to particular groups of devices, only. For instance, you can upgrade the devices of the model `BBB` located on site `AAA` on a single run. 

Example of the inventory output:

```json
{
  "ACM700x": [
    "eee2-nts01.example.org"
  ],
  "CM41xx": [
    "kkk1-nts01.example.org"
  ],
  "ooo1": [
    "ooo1-nts1.example.org"
  ],
  "ooo1_IM72xx": [
    "ooo1-nts1.example.org"
  ],
  "ccc2": [
    "ccc2-nts1.example.org",
    "ccc2-nts3.example.org",
    "ccc2-nts2.example.org"
  ],
  "ccc2_IM42xx": [
    "ccc2-nts1.example.org"
  ],
  "ccc2_IM72xx": [
    "ccc2-nts3.example.org",
    "ccc2-nts2.example.org"
  ],
```


## Playbooks

1. Configuration backup

First, start the FTP server script from `scripts` directory:

```
./ftp_server.py
[I 2019-09-19 16:51:39] >>> starting FTP server on :::21, pid=57628 <<<
[I 2019-09-19 16:51:39] concurrency model: async
[I 2019-09-19 16:51:39] masquerade (NAT) address: None
[I 2019-09-19 16:51:39] passive ports: 60000->65534
```

```bash
ansible-playbook playbooks/bakup_config.yml -i inventory/ -k
```

2. Show opengear versions

```bash
ansible-playbook playbooks/show_version.yml -i inventory/ -k
```

3. Fetch opengear info to csv file

```bash
ansible-playbook playbooks/get_version.yml -i inventory/ -k
```

4. Upgrade

Make sure that the right image for this particular model is used. You will need to add it for each host manually (see the example below). I am probably going to improve it later on, but it is as it is for now.

```
[ggg2]
ggg2-nts01.example.org upgrade_url='http://ftp.opengear.com/download/releeee/current/4.6.0/im72xx-4.6.0.flash'
```

```bash
ansible-playbook playbooks/upgrade.yml -i inventory/ -k
```

The opengear host will download the firmware and install it. Ansible script will disconnect with an error in a process, that's normal. It will take some time for the process to finish. You can run the `show_version` playbook once it's done, to be sure that it worked.

## FTP server

I use the python script to run a FTP server on my mac. Change the address of your laprop in `group_vars/all`. Run the script from `scripts/ftp_server.py`.

You can use any other FTP server you like.
